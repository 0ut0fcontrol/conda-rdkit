steps:
- bash: |
    wget https://github.com/phracker/MacOSX-SDKs/releases/download/10.15/MacOSX$(target_platform).sdk.tar.xz
    tar Jxvf MacOSX$(target_platform).sdk.tar.xz
  displayName: Install MacOSX $(target_platform) SDK
- script: |
    echo "Removing homebrew from Azure to avoid conflicts."
    curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall > ~/uninstall_homebrew
    chmod +x ~/uninstall_homebrew
    ~/uninstall_homebrew -fq
    rm ~/uninstall_homebrew
  displayName: Remove homebrew
- bash: |
    source ${CONDA}/etc/profile.d/conda.sh
    sudo chown -R ${USER} ${CONDA}
    conda config --set always_yes yes --set changeps1 no
    conda update -q conda
    conda install conda-build
  displayName: Setup build environment
- bash: |
    source ${CONDA}/etc/profile.d/conda.sh
    export CONDA_PY=${PYTHON_VERSION}
    sed -i 's/git_rev: Release_2020_03/git_rev: master/; s/^  version:/# version;/; s/# nightly version:/version:/' rdkit/meta.yaml
    conda build rdkit
  displayName: Do conda build and test
- bash: |
    mkdir -p $(System.DefaultWorkingDirectory)/distrib/macos
    echo "-----------------"
    ls -l /usr/share/miniconda/conda-bld/*
    cp /usr/share/miniconda/conda-bld/macos/rdkit* $(System.DefaultWorkingDirectory)/distrib/linux-64
  displayName: Create build artifacts
- publish: $(System.DefaultWorkingDirectory)/distrib 
  artifact: conda_build_rdkit_linux_$(python.version)

